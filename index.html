<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Simulator v1.0</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <span class="title">Engine Simulator</span>
            <span class="spacer"></span>
            <span class="status">READY</span>
        </div>

        <!-- Sidebar - Control Parameters with Tabs -->
        <div class="sidebar">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-button active" data-tab="physical">Physical Config</button>
                <button class="tab-button" data-tab="ecu">Diesel ECU</button>
            </div>

            <!-- Physical Configuration Tab -->
            <div id="physical-tab" class="tab-content active">
                <div class="panel">
                    <div class="panel-header">Engine Geometry</div>
                    <div class="panel-content">
                        <div class="control-group">
                            <label class="control-label">Bore (mm)</label>
                            <input type="number" class="control-input" value="137" min="50" max="200">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Stroke (mm)</label>
                            <input type="number" class="control-input" value="150" min="50" max="200">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Compression Ratio</label>
                            <input type="number" class="control-input" value="16.5" min="12" max="22" step="0.1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Cylinders</label>
                            <input type="number" class="control-input" value="6" min="1" max="12">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">Operating Conditions</div>
                    <div class="panel-content">
                        <div class="control-group">
                            <label class="control-label">Engine Speed (RPM)</label>
                            <input type="number" class="control-input" value="1800" min="500" max="8000" step="100">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Load (%)</label>
                            <input type="number" class="control-input" value="75" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Intake Temperature (°C)</label>
                            <input type="number" class="control-input" value="25" min="-20" max="60">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ECU Configuration Tab -->
            <div id="ecu-tab" class="tab-content">
                <div class="panel">
                    <div class="panel-header">Fuel Delivery</div>
                    <div class="panel-content">
                        <div class="control-group">
                            <label class="control-label">Base Injection Timing (°BTDC)</label>
                            <input type="number" class="ecu-input" value="15" min="5" max="35" step="0.5">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Injection Pressure (bar)</label>
                            <input type="number" class="ecu-input" value="1800" min="1000" max="2500" step="50">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Pilot Injection (%)</label>
                            <input type="number" class="ecu-input" value="15" min="0" max="30" step="1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">EGR Rate (%)</label>
                            <input type="number" class="ecu-input" value="20" min="0" max="40" step="1">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">Boost & Air</div>
                    <div class="panel-content">
                        <div class="control-group">
                            <label class="control-label">Target Boost (bar)</label>
                            <input type="number" class="ecu-input" value="2.0" min="0" max="3.5" step="0.1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Wastegate Duty (%)</label>
                            <input type="number" class="ecu-input" value="45" min="0" max="100" step="1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">VGT Position (%)</label>
                            <input type="number" class="ecu-input" value="60" min="0" max="100" step="1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">MAF Scaling</label>
                            <input type="number" class="ecu-input" value="1.0" min="0.8" max="1.2" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">Correction Tables</div>
                    <div class="panel-content">
                        <button class="btn" style="width: 100%; margin-bottom: 4px;" onclick="showFuelMap()">View Fuel Map</button>
                        <button class="btn" style="width: 100%; margin-bottom: 4px;" onclick="showVETable()">View VE Table</button>
                        <button class="btn" style="width: 100%; margin-bottom: 4px;" onclick="showTimingMap()">Timing Map</button>
                        <button class="btn" style="width: 100%;" onclick="showBoostMap()">Boost Target</button>
                    </div>
                </div>
            </div>

            <!-- Control Buttons (always visible) -->
            <div class="panel control-panel">
                <div class="panel-header">Control</div>
                <div class="panel-content">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;">Run Simulation</button>
                    <button class="btn" style="width: 100%; margin-bottom: 8px;">Reset Parameters</button>
                    <button class="btn" style="width: 100%;">Export Data</button>
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="canvas-area">
            <div class="visualization-placeholder">
                <div>Visualization Area</div>
                <div style="font-size: 12px; margin-top: 8px;">P-V Diagrams, Performance Charts, and 3D Visualizations will appear here</div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties">
            <div class="panel">
                <div class="panel-header">Performance Output</div>
                <div class="panel-content">
                    <div class="data-display">
                        <div class="data-row">
                            <span class="data-label">Power:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">kW</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Torque:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">Nm</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">BMEP:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">bar</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Efficiency:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">%</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Emissions</div>
                <div class="panel-content">
                    <div class="data-display">
                        <div class="data-row">
                            <span class="data-label">NOx:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">CO:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">HC:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">PM:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Cycle Analysis</div>
                <div class="panel-content">
                    <div class="data-display">
                        <div class="data-row">
                            <span class="data-label">Max Pressure:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">bar</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Max Temperature:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">K</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Pumping Loss:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">kW</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span class="status-item">Simulation: <span class="status-ready">Ready</span></span>
            <span class="status-item">Last Run: Never</span>
            <span class="status-item">Computation Time: ---</span>
            <span class="status-item">Engine Simulator v1.0</span>
        </div>
    </div>

    <script>
        // Inline Engine Simulator (no modules needed)
        console.log('Initializing inline engine simulator...');
        
        class EngineSimulator {
            constructor() {
                this.parameters = {
                    bore: 137,           // mm - Typical for 13L/6cyl engine
                    stroke: 150,         // mm - Typical for 13L diesel
                    compressionRatio: 16.5,  // Higher CR for diesel
                    cylinders: 6,        // 6-cylinder engine
                    engineSpeed: 1800,   // rpm - Typical diesel operating speed
                    load: 75,
                    intakeTemp: 25
                };
                
                this.ecuParameters = {
                    injectionTiming: 15,    // °BTDC
                    injectionPressure: 1800, // bar
                    pilotInjection: 15,     // %
                    egrRate: 20,           // %
                    targetBoost: 2.0,      // bar
                    wastegateduty: 45,     // %
                    vgtPosition: 60,       // %
                    mafScaling: 1.0        // multiplier
                };
                
                this.worker = null;
                this.isSimulating = false;
                this.lastResults = null;
                this.canvas = null;
                this.ctx = null;
                this.chartType = 'pv-diagram';
                this.selectedYParameter = 'pressure';
                
                this.setupWorker();
                this.setupTabs();
                this.bindEventListeners();
                this.setupVisualization();
            }
            
            setupWorker() {
                try {
                    this.worker = new Worker('js/workers/simulation.worker.js');
                    this.worker.addEventListener('message', (event) => this.handleWorkerMessage(event));
                    this.worker.addEventListener('error', (error) => this.handleWorkerError(error));
                    console.log('Worker initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize worker:', error);
                    this.updateStatus('Worker initialization failed', 'error');
                }
            }
            
            handleWorkerMessage(event) {
                const { type, data } = event.data;
                
                switch (type) {
                    case 'simulation_started':
                        this.updateStatus('Simulation running...', 'running');
                        break;
                        
                    case 'simulation_complete':
                        this.isSimulating = false;
                        this.updateStatus('Simulation complete', 'ready');
                        this.updateResults(data);
                        this.lastResults = data;
                        
                        // Update visualization with cycle data
                        if (data.cycle) {
                            this.updateVisualization(data.cycle);
                        }
                        break;
                        
                    case 'simulation_progress':
                        // Update progress if needed
                        break;
                        
                    case 'simulation_error':
                        this.isSimulating = false;
                        this.updateStatus(`Error: ${data.error}`, 'error');
                        break;
                }
            }
            
            handleWorkerError(error) {
                console.error('Worker error:', error);
                this.isSimulating = false;
                this.updateStatus('Simulation error occurred', 'error');
            }
            
            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const targetTab = e.target.dataset.tab;
                        this.switchTab(targetTab);
                    });
                });
            }
            
            switchTab(tabName) {
                // Remove active class from all tabs and buttons
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and button
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }
            
            bindEventListeners() {
                // Physical parameter inputs
                const inputElements = document.querySelectorAll('.control-input');
                const parameters = ['bore', 'stroke', 'compressionRatio', 'cylinders', 'engineSpeed', 'load', 'intakeTemp'];
                
                inputElements.forEach((input, index) => {
                    if (index < parameters.length) {
                        input.addEventListener('input', (e) => {
                            this.updateParameter(parameters[index], parseFloat(e.target.value));
                        });
                        
                        input.addEventListener('change', (e) => {
                            this.validateParameter(parameters[index], parseFloat(e.target.value), e.target);
                        });
                    }
                });
                
                // ECU parameter inputs
                const ecuInputElements = document.querySelectorAll('.ecu-input');
                const ecuParameters = ['injectionTiming', 'injectionPressure', 'pilotInjection', 'egrRate', 'targetBoost', 'wastegateduty', 'vgtPosition', 'mafScaling'];
                
                ecuInputElements.forEach((input, index) => {
                    if (index < ecuParameters.length) {
                        input.addEventListener('input', (e) => {
                            this.updateECUParameter(ecuParameters[index], parseFloat(e.target.value));
                        });
                        
                        input.addEventListener('change', (e) => {
                            this.validateECUParameter(ecuParameters[index], parseFloat(e.target.value), e.target);
                        });
                    }
                });
                
                // Control buttons
                const runButton = document.querySelector('.btn-primary');
                const resetButton = document.querySelector('.btn:not(.btn-primary):first-of-type');
                const exportButton = document.querySelector('.btn:not(.btn-primary):last-of-type');
                
                if (runButton) {
                    runButton.addEventListener('click', () => this.runSimulation());
                }
                
                if (resetButton) {
                    resetButton.addEventListener('click', () => this.resetParameters());
                }
                
                if (exportButton) {
                    exportButton.addEventListener('click', () => this.exportData());
                }
            }
            
            updateParameter(parameter, value) {
                this.parameters[parameter] = value;
            }
            
            updateECUParameter(parameter, value) {
                this.ecuParameters[parameter] = value;
            }
            
            validateParameter(parameter, value, inputElement) {
                let isValid = true;
                let errorMessage = '';

                switch (parameter) {
                    case 'bore':
                        if (value < 50 || value > 200) {
                            isValid = false;
                            errorMessage = 'Bore must be between 50-200mm';
                        }
                        break;
                    case 'stroke':
                        if (value < 50 || value > 200) {
                            isValid = false;
                            errorMessage = 'Stroke must be between 50-200mm';
                        }
                        break;
                    case 'compressionRatio':
                        if (value < 12 || value > 22) {
                            isValid = false;
                            errorMessage = 'Compression ratio must be between 12-22 (diesel)';
                        }
                        break;
                    case 'cylinders':
                        if (value < 1 || value > 12) {
                            isValid = false;
                            errorMessage = 'Cylinders must be between 1-12';
                        }
                        break;
                    case 'engineSpeed':
                        if (value < 500 || value > 8000) {
                            isValid = false;
                            errorMessage = 'Engine speed must be between 500-8000 rpm';
                        }
                        break;
                    case 'load':
                        if (value < 0 || value > 100) {
                            isValid = false;
                            errorMessage = 'Load must be between 0-100%';
                        }
                        break;
                    case 'intakeTemp':
                        if (value < -20 || value > 60) {
                            isValid = false;
                            errorMessage = 'Intake temperature must be between -20-60°C';
                        }
                        break;
                }

                if (!isValid) {
                    inputElement.style.borderColor = '#f56565';
                    this.updateStatus(errorMessage, 'error');
                } else {
                    inputElement.style.borderColor = '#4a5568';
                }

                return isValid;
            }
            
            validateECUParameter(parameter, value, inputElement) {
                let isValid = true;
                let errorMessage = '';

                switch (parameter) {
                    case 'injectionTiming':
                        if (value < 5 || value > 35) {
                            isValid = false;
                            errorMessage = 'Injection timing must be between 5-35°BTDC';
                        }
                        break;
                    case 'injectionPressure':
                        if (value < 1000 || value > 2500) {
                            isValid = false;
                            errorMessage = 'Injection pressure must be between 1000-2500 bar';
                        }
                        break;
                    case 'pilotInjection':
                        if (value < 0 || value > 30) {
                            isValid = false;
                            errorMessage = 'Pilot injection must be between 0-30%';
                        }
                        break;
                    case 'egrRate':
                        if (value < 0 || value > 40) {
                            isValid = false;
                            errorMessage = 'EGR rate must be between 0-40%';
                        }
                        break;
                    case 'targetBoost':
                        if (value < 0 || value > 3.5) {
                            isValid = false;
                            errorMessage = 'Target boost must be between 0-3.5 bar';
                        }
                        break;
                    case 'wastegateduty':
                        if (value < 0 || value > 100) {
                            isValid = false;
                            errorMessage = 'Wastegate duty must be between 0-100%';
                        }
                        break;
                    case 'vgtPosition':
                        if (value < 0 || value > 100) {
                            isValid = false;
                            errorMessage = 'VGT position must be between 0-100%';
                        }
                        break;
                    case 'mafScaling':
                        if (value < 0.8 || value > 1.2) {
                            isValid = false;
                            errorMessage = 'MAF scaling must be between 0.8-1.2';
                        }
                        break;
                }

                if (!isValid) {
                    inputElement.style.borderColor = '#f56565';
                    this.updateStatus(errorMessage, 'error');
                } else {
                    inputElement.style.borderColor = '#4a5568';
                }

                return isValid;
            }
            
            runSimulation() {
                if (this.isSimulating || !this.worker) {
                    return;
                }

                this.isSimulating = true;
                
                // Convert temperature to Kelvin for simulation
                const simulationParams = {
                    ...this.parameters,
                    intakeTemp: this.parameters.intakeTemp + 273.15
                };

                // Send simulation request to worker
                this.worker.postMessage({
                    type: 'simulate',
                    data: simulationParams
                });
            }
            
            resetParameters() {
                const defaultParams = {
                    bore: 137,
                    stroke: 150,
                    compressionRatio: 16.5,
                    cylinders: 6,
                    engineSpeed: 1800,
                    load: 75,
                    intakeTemp: 25
                };

                this.parameters = { ...defaultParams };
                
                const inputs = document.querySelectorAll('.control-input');
                const values = [137, 150, 16.5, 6, 1800, 75, 25];
                
                inputs.forEach((input, index) => {
                    if (index < values.length) {
                        input.value = values[index];
                        input.style.borderColor = '#4a5568';
                    }
                });

                this.clearResults();
                this.updateStatus('Parameters reset', 'ready');
            }
            
            updateResults(data) {
                const { performance, emissions } = data;
                
                const dataValues = document.querySelectorAll('.data-value');
                const values = [
                    performance.power,
                    performance.torque,
                    performance.bmep,
                    performance.efficiency,
                    emissions.nox,
                    emissions.co,
                    emissions.hc,
                    emissions.pm,
                    performance.maxPressure,
                    performance.maxTemperature,
                    '---' // Pumping loss placeholder
                ];
                
                dataValues.forEach((element, index) => {
                    if (index < values.length) {
                        element.textContent = typeof values[index] === 'number' ? 
                            Math.round(values[index] * 10) / 10 : values[index];
                    }
                });
            }
            
            clearResults() {
                const dataValues = document.querySelectorAll('.data-value');
                dataValues.forEach(element => {
                    element.textContent = '---';
                });
            }
            
            updateStatus(message, type = 'ready') {
                const statusElement = document.querySelector('.header .status');
                const statusBarElement = document.querySelector('.status-ready');
                
                if (statusElement) {
                    statusElement.textContent = message.toUpperCase();
                }
                
                if (statusBarElement) {
                    statusBarElement.textContent = message;
                    statusBarElement.className = `status-${type}`;
                }
            }
            
            setupVisualization() {
                const canvasArea = document.querySelector('.canvas-area');
                if (!canvasArea) return;

                // Clear existing content
                canvasArea.innerHTML = '';

                // Create main canvas
                this.canvas = document.createElement('canvas');
                this.canvas.width = canvasArea.clientWidth - 20;
                this.canvas.height = canvasArea.clientHeight - 20;
                this.canvas.style.border = '1px solid #4a5568';
                this.canvas.style.backgroundColor = '#0f1419';
                
                this.ctx = this.canvas.getContext('2d');
                canvasArea.appendChild(this.canvas);

                // Create data table container
                this.dataTableContainer = document.createElement('div');
                this.dataTableContainer.style.cssText = `
                    display: none;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background: #0f1419;
                    font-family: 'Consolas', monospace;
                    font-size: 10px;
                    border: 1px solid #4a5568;
                `;
                canvasArea.appendChild(this.dataTableContainer);

                // Create chart controls
                this.createChartControls(canvasArea);
            }
            
            createChartControls(canvasArea) {
                const controlsDiv = document.createElement('div');
                controlsDiv.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(26, 32, 44, 0.9);
                    border: 1px solid #4a5568;
                    border-radius: 4px;
                    padding: 8px;
                    font-size: 11px;
                    z-index: 10;
                `;

                const chartTypeSelect = document.createElement('select');
                chartTypeSelect.style.cssText = `
                    background: #1a202c; color: #e2e8f0; border: 1px solid #4a5568;
                    padding: 2px; font-size: 11px; margin-bottom: 8px;
                `;
                chartTypeSelect.innerHTML = `
                    <option value="pv-diagram">P-V Diagram</option>
                    <option value="angle-plot">Angle Plot</option>
                    <option value="data-table">Data Table</option>
                `;
                
                chartTypeSelect.addEventListener('change', (e) => {
                    this.chartType = e.target.value;
                    if (this.lastResults) {
                        this.updateVisualization(this.lastResults.cycle);
                    }
                });

                controlsDiv.appendChild(chartTypeSelect);
                canvasArea.appendChild(controlsDiv);
            }
            
            updateVisualization(cycleData) {
                if (!cycleData || !cycleData.length) return;

                if (this.chartType === 'data-table') {
                    this.canvas.style.display = 'none';
                    this.dataTableContainer.style.display = 'block';
                    this.updateDataTable(cycleData);
                } else {
                    this.canvas.style.display = 'block';
                    this.dataTableContainer.style.display = 'none';
                    this.clearCanvas();
                    
                    if (this.chartType === 'pv-diagram') {
                        this.drawPVDiagram(cycleData);
                    } else {
                        this.drawAnglePlot(cycleData);
                    }
                }
            }
            
            clearCanvas() {
                this.ctx.fillStyle = '#0f1419';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            drawPVDiagram(cycleData) {
                const margin = 50;
                const plotWidth = this.canvas.width - 2 * margin;
                const plotHeight = this.canvas.height - 2 * margin;

                const volumes = cycleData.map(d => d.volume);
                const pressures = cycleData.map(d => d.pressure);
                
                const vMin = Math.min(...volumes);
                const vMax = Math.max(...volumes);
                const pMin = Math.min(...pressures);
                const pMax = Math.max(...pressures);

                const vRange = vMax - vMin;
                const pRange = pMax - pMin;
                const vMinPlot = vMin - vRange * 0.1;
                const vMaxPlot = vMax + vRange * 0.1;
                const pMinPlot = pMin - pRange * 0.1;
                const pMaxPlot = pMax + pRange * 0.1;

                // Draw axes
                this.ctx.strokeStyle = '#4a5568';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.moveTo(margin, margin);
                this.ctx.lineTo(margin, this.canvas.height - margin);
                this.ctx.lineTo(this.canvas.width - margin, this.canvas.height - margin);
                this.ctx.stroke();

                // Draw P-V curve
                this.ctx.strokeStyle = '#68d391';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();

                for (let i = 0; i < cycleData.length; i++) {
                    const data = cycleData[i];
                    const x = margin + ((data.volume - vMinPlot) / (vMaxPlot - vMinPlot)) * plotWidth;
                    const y = this.canvas.height - margin - ((data.pressure - pMinPlot) / (pMaxPlot - pMinPlot)) * plotHeight;
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.stroke();

                // Draw labels
                this.ctx.fillStyle = '#a0aec0';
                this.ctx.font = '12px Consolas';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('Volume (cm³)', this.canvas.width / 2, this.canvas.height - 10);

                this.ctx.save();
                this.ctx.translate(15, this.canvas.height / 2);
                this.ctx.rotate(-Math.PI / 2);
                this.ctx.fillText('Pressure (bar)', 0, 0);
                this.ctx.restore();
            }
            
            drawAnglePlot(cycleData) {
                const margin = 50;
                const plotWidth = this.canvas.width - 2 * margin;
                const plotHeight = this.canvas.height - 2 * margin;

                const angles = cycleData.map(d => d.angle);
                const values = cycleData.map(d => d[this.selectedYParameter]);
                
                const angleMin = Math.min(...angles);
                const angleMax = Math.max(...angles);
                const valueMin = Math.min(...values);
                const valueMax = Math.max(...values);

                const valueRange = valueMax - valueMin;
                const valueMinPlot = valueMin - valueRange * 0.1;
                const valueMaxPlot = valueMax + valueRange * 0.1;

                // Draw axes
                this.ctx.strokeStyle = '#4a5568';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.moveTo(margin, margin);
                this.ctx.lineTo(margin, this.canvas.height - margin);
                this.ctx.lineTo(this.canvas.width - margin, this.canvas.height - margin);
                this.ctx.stroke();

                // Draw data line
                this.ctx.strokeStyle = '#63b3ed';
                this.ctx.lineWidth = 1.5;
                this.ctx.beginPath();

                for (let i = 0; i < cycleData.length; i++) {
                    const data = cycleData[i];
                    const x = margin + ((data.angle - angleMin) / (angleMax - angleMin)) * plotWidth;
                    const y = this.canvas.height - margin - ((data[this.selectedYParameter] - valueMinPlot) / (valueMaxPlot - valueMinPlot)) * plotHeight;
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.stroke();

                // Draw labels
                this.ctx.fillStyle = '#a0aec0';
                this.ctx.font = '12px Consolas';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('Crank Angle (degrees)', this.canvas.width / 2, this.canvas.height - 10);
            }
            
            updateDataTable(cycleData) {
                if (!cycleData.length) return;

                const table = document.createElement('table');
                table.style.cssText = `
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 9px;
                    color: #e2e8f0;
                `;

                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const headers = [
                    'Angle°', 'Volume cm³', 'Pressure bar', 'Temperature K', 'Piston Pos mm',
                    'Piston Vel m/s', 'Piston Acc m/s²', 'Mass kg', 'Density kg/m³', 'Comp Ratio',
                    'Heat Release J/°', 'Heat Total J', 'Heat Transfer J/°', 'HT Coeff W/m²K', 
                    'Surface cm²', 'Mean Piston Speed m/s', 'Gas Vel m/s', 'Phase', 
                    'Intake', 'Exhaust', 'Combustion', 'Progress %'
                ];

                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.style.cssText = `
                        border: 1px solid #4a5568;
                        padding: 4px;
                        background: #2d3748;
                        color: #cbd5e0;
                        font-weight: bold;
                        text-align: center;
                        position: sticky;
                        top: 0;
                        font-size: 8px;
                        min-width: 60px;
                    `;
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Create body with all data points (0.1° resolution = 7200 points)
                const tbody = document.createElement('tbody');
                
                // Show every 5th data point for performance (0.5° resolution = 1440 points)
                const sampleRate = 5;
                
                for (let i = 0; i < cycleData.length; i += sampleRate) {
                    const data = cycleData[i];
                    const row = document.createElement('tr');
                    
                    const values = [
                        data.angle || 0,
                        data.volume || 0,
                        data.pressure || 0,
                        data.temperature || 0,
                        data.pistonPosition || 0,
                        data.pistonVelocity || 0,
                        data.pistonAcceleration || 0,
                        data.massInCylinder || 0,
                        data.density || 0,
                        data.compressionRatio || 0,
                        data.heatRelease || 0,
                        data.heatReleaseTotal || 0,
                        data.heatTransfer || 0,
                        data.heatTransferCoeff || 0,
                        data.surfaceArea || 0,
                        data.meanPistonSpeed || 0,
                        data.gasVelocity || 0,
                        data.strokePhase || 'Unknown',
                        data.intakeValveOpen ? '●' : '○',
                        data.exhaustValveOpen ? '●' : '○',
                        data.combustionActive ? '●' : '○',
                        data.cycleProgress || 0
                    ];

                    // Color code rows by stroke phase
                    let backgroundColor = '#1a202c';
                    if (data.strokePhase === 'Intake') backgroundColor = '#1a365d';
                    else if (data.strokePhase === 'Compression') backgroundColor = '#744210';
                    else if (data.strokePhase === 'Power') backgroundColor = '#22543d';
                    else if (data.strokePhase === 'Exhaust') backgroundColor = '#702459';

                    values.forEach((value, index) => {
                        const td = document.createElement('td');
                        td.style.cssText = `
                            border: 1px solid #4a5568;
                            padding: 2px 4px;
                            text-align: ${index === 17 ? 'left' : 'right'};
                            background: ${backgroundColor};
                            font-size: 8px;
                        `;
                        
                        // Format numbers appropriately
                        if (typeof value === 'number') {
                            if (index <= 16) { // Numeric values
                                td.textContent = Math.round(value * 1000) / 1000;
                            } else { // Progress percentage
                                td.textContent = Math.round(value * 10) / 10 + '%';
                            }
                        } else {
                            td.textContent = value;
                        }
                        
                        row.appendChild(td);
                    });
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);

                // Add summary info
                const summaryDiv = document.createElement('div');
                summaryDiv.style.cssText = `
                    padding: 10px;
                    background: #2d3748;
                    color: #cbd5e0;
                    font-size: 11px;
                    border-bottom: 1px solid #4a5568;
                `;
                summaryDiv.innerHTML = `
                    <strong>Data Table Summary:</strong><br>
                    • Total data points: ${cycleData.length} (0.1° resolution)<br>
                    • Displayed: ${Math.ceil(cycleData.length / sampleRate)} rows (0.5° sampling for performance)<br>
                    • Color coding: <span style="background:#1a365d; padding:2px 4px;">Intake</span> 
                    <span style="background:#744210; padding:2px 4px;">Compression</span> 
                    <span style="background:#22543d; padding:2px 4px;">Power</span> 
                    <span style="background:#702459; padding:2px 4px;">Exhaust</span><br>
                    • Valve status: ● Open, ○ Closed
                `;

                this.dataTableContainer.innerHTML = '';
                this.dataTableContainer.appendChild(summaryDiv);
                this.dataTableContainer.appendChild(table);
            }
            
            exportData() {
                if (!this.lastResults) {
                    this.updateStatus('No data to export', 'error');
                    return;
                }

                const choice = prompt('Export options:\n1. JSON Data\n2. CSV Data\n3. Visualization Image\n\nEnter choice (1-3):');
                
                switch (choice) {
                    case '1':
                        this.exportJSONData();
                        break;
                    case '2':
                        this.exportCSVData();
                        break;
                    case '3':
                        this.exportVisualization();
                        break;
                    default:
                        this.updateStatus('Export cancelled', 'ready');
                }
            }
            
            exportJSONData() {
                const exportData = {
                    parameters: this.parameters,
                    results: this.lastResults,
                    timestamp: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `engine_simulation_${Date.now()}.json`;
                link.click();
                
                this.updateStatus('JSON data exported', 'ready');
            }
            
            exportCSVData() {
                if (!this.lastResults || !this.lastResults.cycle) {
                    this.updateStatus('No cycle data to export', 'error');
                    return;
                }

                const cycleData = this.lastResults.cycle;
                const headers = Object.keys(cycleData[0]);
                
                let csvContent = headers.join(',') + '\n';
                
                cycleData.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' ? `"${value}"` : value;
                    });
                    csvContent += values.join(',') + '\n';
                });

                const csvBlob = new Blob([csvContent], { type: 'text/csv' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(csvBlob);
                link.download = `engine_cycle_data_${Date.now()}.csv`;
                link.click();
                
                this.updateStatus('CSV data exported', 'ready');
            }
            
            exportVisualization() {
                if (!this.canvas) return;

                const link = document.createElement('a');
                link.download = `engine_${this.chartType}_${Date.now()}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
                
                this.updateStatus('Visualization exported', 'ready');
            }
            
            // ECU Table Visualization Methods
            showFuelMapVisualization() {
                this.canvas.style.display = 'block';
                this.dataTableContainer.style.display = 'none';
                this.clearCanvas();
                this.drawFuelMap();
            }
            
            showVETableVisualization() {
                this.canvas.style.display = 'block';
                this.dataTableContainer.style.display = 'none';
                this.clearCanvas();
                this.drawVETable();
            }
            
            showTimingMapVisualization() {
                this.canvas.style.display = 'block';
                this.dataTableContainer.style.display = 'none';
                this.clearCanvas();
                this.drawTimingMap();
            }
            
            showBoostMapVisualization() {
                this.canvas.style.display = 'block';
                this.dataTableContainer.style.display = 'none';
                this.clearCanvas();
                this.drawBoostMap();
            }
            
            drawFuelMap() {
                const margin = 60;
                const plotWidth = this.canvas.width - 2 * margin;
                const plotHeight = this.canvas.height - 2 * margin;

                // Diesel fuel map data (RPM vs Load)
                const rpmAxis = [1000, 1300, 1600, 1900, 2200, 2500, 2800, 3100];
                const loadAxis = [10, 25, 40, 55, 70, 85, 100];
                
                // Fuel quantity map (mg/cycle) - typical diesel values
                const fuelMap = [
                    [8, 12, 18, 25, 32, 38, 45],    // 1000 RPM
                    [10, 15, 22, 30, 38, 46, 55],   // 1300 RPM
                    [12, 18, 26, 35, 45, 55, 65],   // 1600 RPM
                    [14, 20, 30, 40, 52, 64, 75],   // 1900 RPM
                    [16, 22, 32, 43, 56, 70, 82],   // 2200 RPM
                    [18, 24, 34, 45, 58, 72, 85],   // 2500 RPM
                    [20, 26, 36, 47, 60, 74, 87],   // 2800 RPM
                    [22, 28, 38, 49, 62, 76, 89]    // 3100 RPM
                ];
                
                this.drawHeatMap(fuelMap, rpmAxis, loadAxis, 'Fuel Quantity Map (mg/cycle)', 'Load (%)', 'RPM');
            }
            
            drawVETable() {
                const margin = 60;
                const plotWidth = this.canvas.width - 2 * margin;
                const plotHeight = this.canvas.height - 2 * margin;

                // VE table data (RPM vs Load)
                const rpmAxis = [1000, 1300, 1600, 1900, 2200, 2500, 2800, 3100];
                const loadAxis = [10, 25, 40, 55, 70, 85, 100];
                
                // Volumetric efficiency values (%) - typical diesel values
                const veMap = [
                    [78, 82, 86, 88, 90, 87, 82],   // 1000 RPM
                    [82, 86, 90, 92, 94, 91, 86],   // 1300 RPM
                    [85, 89, 93, 95, 97, 94, 89],   // 1600 RPM
                    [88, 92, 96, 98, 98, 95, 90],   // 1900 RPM
                    [86, 90, 94, 96, 96, 93, 88],   // 2200 RPM
                    [84, 88, 92, 94, 94, 91, 86],   // 2500 RPM
                    [80, 84, 88, 90, 90, 87, 82],   // 2800 RPM
                    [76, 80, 84, 86, 86, 83, 78]    // 3100 RPM
                ];
                
                this.drawHeatMap(veMap, rpmAxis, loadAxis, 'Volumetric Efficiency Table (%)', 'Load (%)', 'RPM');
            }
            
            drawTimingMap() {
                const margin = 60;
                const rpmAxis = [1000, 1300, 1600, 1900, 2200, 2500, 2800, 3100];
                const loadAxis = [10, 25, 40, 55, 70, 85, 100];
                
                // Injection timing map (degrees BTDC)
                const timingMap = [
                    [8, 10, 12, 14, 16, 18, 20],    // 1000 RPM
                    [9, 11, 13, 15, 17, 19, 21],    // 1300 RPM
                    [10, 12, 14, 16, 18, 20, 22],   // 1600 RPM
                    [11, 13, 15, 17, 19, 21, 23],   // 1900 RPM
                    [12, 14, 16, 18, 20, 22, 24],   // 2200 RPM
                    [13, 15, 17, 19, 21, 23, 25],   // 2500 RPM
                    [14, 16, 18, 20, 22, 24, 26],   // 2800 RPM
                    [15, 17, 19, 21, 23, 25, 27]    // 3100 RPM
                ];
                
                this.drawHeatMap(timingMap, rpmAxis, loadAxis, 'Injection Timing Map (°BTDC)', 'Load (%)', 'RPM');
            }
            
            drawBoostMap() {
                const margin = 60;
                const rpmAxis = [1000, 1300, 1600, 1900, 2200, 2500, 2800, 3100];
                const loadAxis = [10, 25, 40, 55, 70, 85, 100];
                
                // Target boost pressure map (bar)
                const boostMap = [
                    [0.0, 0.2, 0.5, 0.8, 1.2, 1.6, 2.0],  // 1000 RPM
                    [0.0, 0.3, 0.6, 1.0, 1.4, 1.8, 2.2],  // 1300 RPM
                    [0.0, 0.4, 0.8, 1.2, 1.6, 2.0, 2.4],  // 1600 RPM
                    [0.0, 0.5, 1.0, 1.4, 1.8, 2.2, 2.6],  // 1900 RPM
                    [0.0, 0.6, 1.1, 1.5, 1.9, 2.3, 2.7],  // 2200 RPM
                    [0.0, 0.6, 1.2, 1.6, 2.0, 2.4, 2.8],  // 2500 RPM
                    [0.0, 0.7, 1.3, 1.7, 2.1, 2.5, 2.9],  // 2800 RPM
                    [0.0, 0.8, 1.4, 1.8, 2.2, 2.6, 3.0]   // 3100 RPM
                ];
                
                this.drawHeatMap(boostMap, rpmAxis, loadAxis, 'Target Boost Pressure Map (bar)', 'Load (%)', 'RPM');
            }
            
            drawHeatMap(dataMap, xAxis, yAxis, title, xLabel, yLabel) {
                const margin = 60;
                const plotWidth = this.canvas.width - 2 * margin;
                const plotHeight = this.canvas.height - 2 * margin;
                
                const cellWidth = plotWidth / xAxis.length;
                const cellHeight = plotHeight / yAxis.length;
                
                // Find min/max for color scaling
                let minVal = Infinity, maxVal = -Infinity;
                dataMap.forEach(row => {
                    row.forEach(val => {
                        minVal = Math.min(minVal, val);
                        maxVal = Math.max(maxVal, val);
                    });
                });
                
                // Draw title
                this.ctx.fillStyle = '#e2e8f0';
                this.ctx.font = 'bold 16px Consolas';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(title, this.canvas.width / 2, 25);
                
                // Draw heat map cells
                for (let i = 0; i < dataMap.length; i++) {
                    for (let j = 0; j < dataMap[i].length; j++) {
                        const value = dataMap[i][j];
                        const normalizedValue = (value - minVal) / (maxVal - minVal);
                        
                        // Color scale from blue (low) to red (high)
                        const red = Math.floor(255 * normalizedValue);
                        const blue = Math.floor(255 * (1 - normalizedValue));
                        const green = Math.floor(128 * (1 - Math.abs(normalizedValue - 0.5) * 2));
                        
                        this.ctx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
                        
                        const x = margin + j * cellWidth;
                        const y = margin + i * cellHeight;
                        
                        this.ctx.fillRect(x, y, cellWidth, cellHeight);
                        
                        // Draw cell border
                        this.ctx.strokeStyle = '#4a5568';
                        this.ctx.lineWidth = 1;
                        this.ctx.strokeRect(x, y, cellWidth, cellHeight);
                        
                        // Draw value text
                        this.ctx.fillStyle = normalizedValue > 0.5 ? '#000000' : '#ffffff';
                        this.ctx.font = '10px Consolas';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(value.toFixed(1), x + cellWidth/2, y + cellHeight/2 + 3);
                    }
                }
                
                // Draw axis labels
                this.ctx.fillStyle = '#e2e8f0';
                this.ctx.font = '12px Consolas';
                this.ctx.textAlign = 'center';
                
                // X-axis labels
                for (let i = 0; i < xAxis.length; i++) {
                    const x = margin + i * cellWidth + cellWidth/2;
                    this.ctx.fillText(xAxis[i], x, this.canvas.height - 15);
                }
                
                // Y-axis labels
                this.ctx.textAlign = 'right';
                for (let i = 0; i < yAxis.length; i++) {
                    const y = margin + i * cellHeight + cellHeight/2;
                    this.ctx.fillText(yAxis[i], margin - 10, y + 3);
                }
                
                // Axis titles
                this.ctx.textAlign = 'center';
                this.ctx.fillText(xLabel, this.canvas.width / 2, this.canvas.height - 35);
                
                this.ctx.save();
                this.ctx.translate(20, this.canvas.height / 2);
                this.ctx.rotate(-Math.PI / 2);
                this.ctx.fillText(yLabel, 0, 0);
                this.ctx.restore();
            }
        }
        
        // Global functions for fuel map visualization
        function showFuelMap() {
            const simulator = window.engineSimulator;
            if (simulator) {
                simulator.showFuelMapVisualization();
            }
        }
        
        function showVETable() {
            const simulator = window.engineSimulator;
            if (simulator) {
                simulator.showVETableVisualization();
            }
        }
        
        function showTimingMap() {
            const simulator = window.engineSimulator;
            if (simulator) {
                simulator.showTimingMapVisualization();
            }
        }
        
        function showBoostMap() {
            const simulator = window.engineSimulator;
            if (simulator) {
                simulator.showBoostMapVisualization();
            }
        }
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const engineSimulator = new EngineSimulator();
                window.engineSimulator = engineSimulator;
                console.log('Engine Simulator initialized successfully (inline version)');
            } catch (error) {
                console.error('Failed to initialize Engine Simulator:', error);
            }
        });
    </script>
</body>
</html>