<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Simulator Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <span class="title">Engine Simulator (Test Version)</span>
            <span class="spacer"></span>
            <span class="status">READY</span>
        </div>

        <!-- Sidebar - Control Parameters -->
        <div class="sidebar">
            <div class="panel">
                <div class="panel-header">Engine Geometry</div>
                <div class="panel-content">
                    <div class="control-group">
                        <label class="control-label">Bore (mm)</label>
                        <input type="number" class="control-input" value="86" min="50" max="150">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Stroke (mm)</label>
                        <input type="number" class="control-input" value="86" min="50" max="150">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Compression Ratio</label>
                        <input type="number" class="control-input" value="10.5" min="8" max="15" step="0.1">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Cylinders</label>
                        <input type="number" class="control-input" value="4" min="1" max="12">
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Operating Conditions</div>
                <div class="panel-content">
                    <div class="control-group">
                        <label class="control-label">Engine Speed (RPM)</label>
                        <input type="number" class="control-input" value="2000" min="500" max="8000" step="100">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Load (%)</label>
                        <input type="number" class="control-input" value="75" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Intake Temperature (°C)</label>
                        <input type="number" class="control-input" value="25" min="-20" max="60">
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Control</div>
                <div class="panel-content">
                    <button class="btn btn-primary" id="runBtn" style="width: 100%; margin-bottom: 8px;">Run Simulation</button>
                    <button class="btn" id="resetBtn" style="width: 100%; margin-bottom: 8px;">Reset Parameters</button>
                    <button class="btn" id="exportBtn" style="width: 100%;">Export Data</button>
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="canvas-area" id="canvasArea">
            <div class="visualization-placeholder">
                <div>Click "Run Simulation" to generate P-V diagram and cycle data</div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties">
            <div class="panel">
                <div class="panel-header">Performance Output</div>
                <div class="panel-content">
                    <div class="data-display">
                        <div class="data-row">
                            <span class="data-label">Power:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">kW</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Torque:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">Nm</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">BMEP:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">bar</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Efficiency:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">%</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Emissions</div>
                <div class="panel-content">
                    <div class="data-display">
                        <div class="data-row">
                            <span class="data-label">NOx:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">CO:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">HC:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">PM:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">g/kWh</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Cycle Analysis</div>
                <div class="panel-content">
                    <div class="data-display">
                        <div class="data-row">
                            <span class="data-label">Max Pressure:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">bar</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Max Temperature:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">K</span></span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Pumping Loss:</span>
                            <span><span class="data-value">---</span> <span class="data-unit">kW</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span class="status-item">Simulation: <span class="status-ready">Ready</span></span>
            <span class="status-item">Last Run: Never</span>
            <span class="status-item">Computation Time: ---</span>
            <span class="status-item">Engine Simulator Test v1.0</span>
        </div>
    </div>

    <script>
        // Simple inline engine simulator (no modules)
        console.log('Initializing inline engine simulator...');
        
        let currentResults = null;
        
        // Otto cycle simulation function
        function simulateOttoCycle(params) {
            console.log('Starting simulation with params:', params);
            
            const { bore, stroke, compressionRatio, cylinders, engineSpeed, load, intakeTemp } = params;
            
            // Basic engine geometry
            const displacement = Math.PI * Math.pow(bore/2, 2) * stroke / 1000; // cm³
            const clearanceVolume = displacement / (compressionRatio - 1);
            const maxVolume = displacement + clearanceVolume;
            
            // Thermodynamic constants
            const gamma = 1.35;
            const R = 287;
            const intakePressure = 101325; // Pa
            const intakeTempK = intakeTemp + 273.15;
            
            const cycleData = [];
            const stepSize = 1.0; // degrees
            
            for (let angle = 0; angle <= 720; angle += stepSize) {
                const crankAngleRad = (angle * Math.PI) / 180;
                const crankRadius = stroke / 2;
                const connectingRodLength = stroke * 1.5;
                
                // Piston position calculation
                const pistonPosition = crankRadius * (
                    (1 - Math.cos(crankAngleRad)) + 
                    (crankRadius / connectingRodLength) * (1 - Math.cos(crankAngleRad))
                );
                
                const volume = clearanceVolume + (Math.PI * Math.pow(bore/2, 2) * pistonPosition) / 1000;
                
                let pressure, temperature;
                let strokePhase;
                
                if (angle >= 0 && angle <= 180) {
                    // Intake stroke
                    strokePhase = 'Intake';
                    pressure = intakePressure / 100000; // bar
                    temperature = intakeTempK;
                } else if (angle > 180 && angle <= 360) {
                    // Compression stroke
                    strokePhase = 'Compression';
                    const compressionRatioInst = maxVolume / volume;
                    pressure = (intakePressure / 100000) * Math.pow(compressionRatioInst, gamma);
                    temperature = intakeTempK * Math.pow(compressionRatioInst, gamma - 1);
                } else if (angle > 360 && angle <= 540) {
                    // Power stroke
                    strokePhase = 'Power';
                    if (angle <= 370) {
                        // Combustion
                        const heatMultiplier = 1.5 + (load/100 * 2.5);
                        const compressionRatioInst = compressionRatio;
                        pressure = (intakePressure / 100000) * Math.pow(compressionRatioInst, gamma) * heatMultiplier;
                        temperature = intakeTempK * Math.pow(compressionRatioInst, gamma - 1) * heatMultiplier;
                    } else {
                        // Expansion
                        const expansionRatio = volume / clearanceVolume;
                        const peakPressure = (intakePressure / 100000) * Math.pow(compressionRatio, gamma) * (1.5 + load/100 * 2.5);
                        const peakTemp = intakeTempK * Math.pow(compressionRatio, gamma - 1) * (1.5 + load/100 * 2.5);
                        pressure = peakPressure / Math.pow(expansionRatio, gamma);
                        temperature = peakTemp / Math.pow(expansionRatio, gamma - 1);
                    }
                } else {
                    // Exhaust stroke
                    strokePhase = 'Exhaust';
                    pressure = (intakePressure / 100000) * 1.05;
                    temperature = intakeTempK * 1.8;
                }
                
                cycleData.push({
                    angle: Math.round(angle * 10) / 10,
                    volume: Math.round(volume * 100) / 100,
                    pressure: Math.round(pressure * 1000) / 1000,
                    temperature: Math.round(temperature * 10) / 10,
                    strokePhase: strokePhase
                });
            }
            
            // Calculate performance
            let workPerCycle = 0;
            for (let i = 1; i < cycleData.length; i++) {
                const dV = (cycleData[i].volume - cycleData[i-1].volume) / 1000; // Convert to L
                const avgP = (cycleData[i].pressure + cycleData[i-1].pressure) / 2 * 100; // Convert to kPa
                workPerCycle += avgP * dV;
            }
            
            const cyclesPerSecond = engineSpeed / 120; // 4-stroke
            const indicatedPower = (workPerCycle * cyclesPerSecond * cylinders) / 1000; // kW
            const brakePower = indicatedPower * 0.85; // Mechanical efficiency
            const brakeTorque = (brakePower * 1000 * 60) / (2 * Math.PI * engineSpeed); // Nm
            
            const maxPressure = Math.max(...cycleData.map(d => d.pressure));
            const maxTemperature = Math.max(...cycleData.map(d => d.temperature));
            
            return {
                cycle: cycleData,
                performance: {
                    power: Math.round(brakePower * 10) / 10,
                    torque: Math.round(brakeTorque * 10) / 10,
                    bmep: Math.round(workPerCycle / displacement * 0.85 * 10) / 10,
                    efficiency: Math.round((1 - 1/Math.pow(compressionRatio, gamma-1)) * 100 * 10) / 10,
                    maxPressure: Math.round(maxPressure * 10) / 10,
                    maxTemperature: Math.round(maxTemperature)
                },
                emissions: {
                    nox: Math.round((maxTemperature > 2000 ? (maxTemperature - 2000) * 0.005 : 0.1) * 100) / 100,
                    co: Math.round((2.5 - load/50) * 100) / 100,
                    hc: Math.round((1.0 - load/100) * 100) / 100,
                    pm: 0.05
                }
            };
        }
        
        // P-V diagram drawing
        function drawPVDiagram(cycleData) {
            console.log('Drawing P-V diagram with', cycleData.length, 'data points');
            
            const canvasArea = document.getElementById('canvasArea');
            canvasArea.innerHTML = '';
            
            const canvas = document.createElement('canvas');
            canvas.width = canvasArea.clientWidth - 20;
            canvas.height = canvasArea.clientHeight - 20;
            canvas.style.border = '1px solid #4a5568';
            canvas.style.backgroundColor = '#0f1419';
            
            const ctx = canvas.getContext('2d');
            canvasArea.appendChild(canvas);
            
            // Get data ranges
            const volumes = cycleData.map(d => d.volume);
            const pressures = cycleData.map(d => d.pressure);
            
            const vMin = Math.min(...volumes);
            const vMax = Math.max(...volumes);
            const pMin = Math.min(...pressures);
            const pMax = Math.max(...pressures);
            
            // Add padding
            const vRange = vMax - vMin;
            const pRange = pMax - pMin;
            const vMinPlot = vMin - vRange * 0.1;
            const vMaxPlot = vMax + vRange * 0.1;
            const pMinPlot = pMin - pRange * 0.1;
            const pMaxPlot = pMax + pRange * 0.1;
            
            const margin = 50;
            const plotWidth = canvas.width - 2 * margin;
            const plotHeight = canvas.height - 2 * margin;
            
            // Draw axes
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, canvas.height - margin);
            ctx.lineTo(canvas.width - margin, canvas.height - margin);
            ctx.stroke();
            
            // Draw P-V curve
            ctx.strokeStyle = '#68d391';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < cycleData.length; i++) {
                const data = cycleData[i];
                const x = margin + ((data.volume - vMinPlot) / (vMaxPlot - vMinPlot)) * plotWidth;
                const y = canvas.height - margin - ((data.pressure - pMinPlot) / (pMaxPlot - pMinPlot)) * plotHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#a0aec0';
            ctx.font = '12px Consolas';
            ctx.textAlign = 'center';
            ctx.fillText('Volume (cm³)', canvas.width / 2, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Pressure (bar)', 0, 0);
            ctx.restore();
        }
        
        // Update results display
        function updateResults(data) {
            const dataValues = document.querySelectorAll('.data-value');
            const { performance, emissions } = data;
            
            const values = [
                performance.power,
                performance.torque,
                performance.bmep,
                performance.efficiency,
                emissions.nox,
                emissions.co,
                emissions.hc,
                emissions.pm,
                performance.maxPressure,
                performance.maxTemperature,
                '---' // Pumping loss placeholder
            ];
            
            dataValues.forEach((element, index) => {
                if (index < values.length) {
                    element.textContent = values[index];
                }
            });
        }
        
        // Event handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, binding event handlers...');
            
            const runBtn = document.getElementById('runBtn');
            const resetBtn = document.getElementById('resetBtn');
            const statusElement = document.querySelector('.status-ready');
            const inputs = document.querySelectorAll('.control-input');
            
            runBtn.addEventListener('click', function() {
                console.log('Run simulation clicked');
                
                // Get parameters from inputs
                const params = {
                    bore: parseFloat(inputs[0].value),
                    stroke: parseFloat(inputs[1].value),
                    compressionRatio: parseFloat(inputs[2].value),
                    cylinders: parseInt(inputs[3].value),
                    engineSpeed: parseInt(inputs[4].value),
                    load: parseFloat(inputs[5].value),
                    intakeTemp: parseFloat(inputs[6].value)
                };
                
                statusElement.textContent = 'RUNNING...';
                statusElement.className = 'status-running';
                
                setTimeout(() => {
                    try {
                        const results = simulateOttoCycle(params);
                        currentResults = results;
                        
                        updateResults(results);
                        drawPVDiagram(results.cycle);
                        
                        statusElement.textContent = 'READY';
                        statusElement.className = 'status-ready';
                        
                        console.log('Simulation completed successfully');
                    } catch (error) {
                        console.error('Simulation error:', error);
                        statusElement.textContent = 'ERROR';
                        statusElement.className = 'status-error';
                    }
                }, 100);
            });
            
            resetBtn.addEventListener('click', function() {
                console.log('Reset clicked');
                const defaultValues = [86, 86, 10.5, 4, 2000, 75, 25];
                inputs.forEach((input, index) => {
                    if (index < defaultValues.length) {
                        input.value = defaultValues[index];
                    }
                });
                
                // Clear results
                document.querySelectorAll('.data-value').forEach(element => {
                    element.textContent = '---';
                });
                
                // Clear canvas
                const canvasArea = document.getElementById('canvasArea');
                canvasArea.innerHTML = '<div class="visualization-placeholder"><div>Click "Run Simulation" to generate P-V diagram and cycle data</div></div>';
            });
            
            console.log('Engine simulator initialized successfully (inline version)');
        });
    </script>
</body>
</html>